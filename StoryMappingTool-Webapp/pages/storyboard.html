<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>storyboard</title>
    <meta name="description" content="这是一个 storyboard 页面">
    <meta name="keywords" content="storyboard">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />


    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="../static/css/amazeui.min.css" />
    <link rel="stylesheet" href="../static/css/admin.css">
    <link rel="stylesheet" href="../static/css/app.css">
    <link rel="stylesheet" href="../static/css/storyboard.css">
    <script src="../static/js/vue.js"></script>
    <script src="../static/js/index.js"></script>
    <script src="../static/js/axios.js"></script>
    <script src="../static/js/html2canvas.js"></script>

</head>

<body style="height:100%">


    <div id="app" class="tpl-page-container tpl-page-header-fixed" ref="cutScreen">
        <header class="am-topbar am-topbar-inverse admin-header">
            <div class="am-topbar-brand">
                <a href="../pages/homepage.html" class="tpl-logo">
                    <img src="../static/img/logo.png" alt="">
                </a>
            </div>

            <div class="am-collapse am-topbar-collapse" id="topbar-collapse">

                <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-right admin-header-list tpl-header-list">
                    <li style="cursor: pointer"><Icon class="el-icon-time"></Icon><span>日志</span></li>
                    <li  style="cursor: pointer" @click="downloadPng()"><Icon class="el-icon-download" ></Icon><span>下载</span></li>

                    <li class="am-hide-sm-only"><a href="javascript:;" id="admin-fullscreen" class="tpl-header-list-link"><span
                            class="am-icon-arrows-alt"></span> <span class="admin-fullText">开启全屏</span></a></li>

                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="tpl-header-list-user-nick"></span><span class="tpl-header-list-user-ico"> <img
                                src="../static/img/user.png"></span>
                        </a>
                        <ul class="am-dropdown-content">
                            <li><a href="#"><span class="am-icon-bell-o"></span> 资料</a></li>
                            <li><a href="#"><span class="am-icon-cog"></span> 设置</a></li>
                            <li><a href="../pages/login.html"><span class="am-icon-power-off"></span> 退出</a></li>
                        </ul>
                    </li>
                    <li><a href="../pages/login.html" class="tpl-header-list-link"><span class="am-icon-sign-out tpl-header-list-ico-out-size"></span></a></li>
                </ul>
            </div>
        </header>
        <!--上面的周期-->
        <ul class="activity-ul">
            <li class="backbone-li" v-for="(backbone,index_backbone) in backboneList">
                <back-bone-component @doubleclick='updatebackbone' :backbone_card="backbone" :index.sync="index_backbone"
                    @insertleft="addbackbone" @insertbottom="addactivity" @insertright="addbackbone">
                </back-bone-component>
                <div class="activity-li">
                    <activity-component v-for="(activity,index_activity) in backbone.activityList" @doubleclick='updateactivity'
                        :activity_card="activity"
                        :backbone_index.sync="index_backbone"
                        :activity_index.sync="index_activity"
                        @insertleft="addactivity" @insertbottom="addstory" @insertright="addactivity"
                        
                        ></activity-component>

                    <!-- <div class="activity-li">
                            <span class="am-icon-plus activity-extend-span"  @click="showActivityModal = 1"></span>
                            <activity-modal v-if="showActivityModal" @close="showActivityModal = 0">
                                    <span slot="header" v-if="showActivityModal == 2">编辑活动</span>
                            </activity-modal>
                            
                    </div> -->          
                </div>
            </li>
            <!-- <li class="backbone-extend">
                <span class="am-icon-plus backbone-extend-span"  @click="showBackBoneModal = 1"></span>
                  
                   <backbone-modal v-if="showBackBoneModal" @close="showBackBoneModal = 0" :backbone_data_in_modal.sync="backboneObject">
                    
                        <span slot="header" v-if="showBackBoneModal == 2">编辑骨干故事</span>
                </backbone-modal>

                

            </li> -->
            <backbone-modal v-if="showBackBoneModal" @close="showBackBoneModal = 0" 
            :backbone_data_in_modal="current_backbone"
:backbone_index="current_backbone_index" @clicksubmit='addOrUpdateBackbone' @clickdelete='deleteBackbone'>

<span slot="header" v-if="showBackBoneModal == 2">编辑骨干故事</span>
</backbone-modal>

<activity-modal v-if="showActivityModal" @close="showActivityModal = 0" :activity_data_in_modal="current_activity"
:backbone_index="current_backbone_index" :activity_index="current_activity_index" @clicksubmit='addOrUpdateActivity' @clickdelete='deleteActivity'>

<span slot="header" v-if="showActivityModal == 2">编辑活动</span>
</activity-modal>


          
        </ul>
        <!--上面的周期结束-->





        <!--  开发周期开始  -->
        <div v-for="(release,index_release) in releaseList">
        <release-component 
        @doubleclick='updaterelease' 
        @addclick='addrelease'
        @showrelease='showrelease'
        :release_card="release" 
        :index.sync="index_release"
        >
        </release-component>
              <!-- 每个迭代的开发周期内容开始-->
        <ul class="activity-ul" v-if="showReleaseContent[index_release].show">
              

                <li class="task-backbone-li" v-for="(backbone,backbone_index) in backboneList">
                    
                        <task-add-component  
                        @clickicon='addstory' 
                        
                        :story_card="current_story" 
                        :backbone_index = "backbone_index"
                        :activity_index = "0"
                        :release_index = "index_release"
                        :seq_id = 0
                        v-if="backbone.activityList.length==0"
                        >
                              
                            </task-add-component>


                           


                    <div class="task-li" v-for="(activity,activity_index) in backbone.activityList">
    
    



                        <task-component 
                        @doubleclick='updatetask'
                        v-for="(story,story_index) in activity.storyList" 
                        v-if="story.releaseId==release.id"
                        :story_card="story"
                        :backbone_index = "backbone_index"
                        :activity_index = "activity_index"
                        :release_index = "index_release"
                        :seq_id = story_index
                        >
                        </task-component>
                        <!-- <task-component  
                        @clickIcon='addstory' 
                        
                        :story_card="current_story"
                        :backbone_index = "backbone_index"
                        :activity_index = "activity_index"
                        :release_index = "index_release"
                        :seq_id = activity.storyList.length
                        >
                            <span  @click='clickIcon' class="am-icon-plus task-extend-span" slot="task_component_content">
                            </span>
                        </task-component>

                        
     -->

     <task-add-component  
     @clickicon='addstory' 
     
     :story_card="current_story" 
     :backbone_index = "backbone_index"
     :activity_index = "activity_index"
     :release_index = "index_release"
     :seq_id = activity.storyList.length
     >
           
         </task-add-component>

                        <!-- <div class="backbone-extend">
                            <span class="am-icon-plus backbone-extend-span"  @click="showTaskModal = true"></span>
                          
                            <task-modal v-if="showTaskModal" @close="showTaskModal = false">
                                
                            </task-modal>
                        </div> -->
                        <task-modal 
                        v-if="showTaskModal"

                        @close="showTaskModal = 0"
                        
                        :task_data_in_modal="current_story"
                        @clicksubmit='addOrUpdateTask' @clickdelete='deleteTask'>

                        
                        
                        >
                                
                        <span slot="header" v-if="showTaskModal == 2">编辑任务</span>
                        </task-modal>
    
                    </div>
                    <!-- <div class="activity-li">
                            <span class="am-icon-plus activity-extend-span"  @click="showActivityModal = 1"></span>
                            <activity-modal v-if="showActivityModal" @close="showActivityModal = 0">
                                    <span slot="header" v-if="showActivityModal == 2">编辑活动</span>
                            </activity-modal>
                    </div> -->
                </li>
    
            </ul>
            <!-- 开发周期内容结束-->

        </div>


        <develop-modal 
        v-if="showDevelopModal" @close="showDevelopModal = 0"
        :release_data_in_modal="current_release"
        @clicksubmit='addOrUpdateRelease' 
        @clickdelete='deleteRelease'>
             <span slot="header" v-if="showDevelopModal == 2">编辑发行周期</span>
        </develop-modal>
        <!--开发周期结束 -->


      
    </div>





    
    <!-------------------------------------js代码---------------------------------------------->
    <script type="text/x-template" id="back_bone_component">
        <div style="width: 200px;margin-right:5px">
            <div class="dashboard-stat blue" @dblclick='doubleclick'>
                <!-- <div class="visual">
                     <i class="am-icon-comments-o"></i>
                </div> -->
                <div class="details">
                    <div class="number">{{backbone_card.title}}</div>
                    <div class="desc">{{backbone_card.description}}</div>
                </div>
                <a class="more" href="#"> &nbsp;
                    <i class="am-icon-angle-left icon-add-left" @click='insertleft'></i>
                    <i class="am-icon-angle-right  tpl-left-nav-more-ico-rotate icon-add-center" @click='insertbottom'></i>
                    <i class="am-icon-angle-right  icon-add-right" @click='insertright'></i>
                </a>
            </div>
        </div>
    </script>
    <script type="text/x-template" id="activity_component">
        <div style="width: 200px; margin-right:5px">
            <div class="dashboard-stat purple" @dblclick='doubleclick'>
                <!-- <div class="visual">
                    <i class="am-icon-bar-chart-o"></i>
                </div> -->
                <div class="details">
                    <div class="number"> {{activity_card.title}} </div>
                    <div class="desc"> {{activity_card.description}} </div>
                </div>
                <!-- <a class="more" href="#"> 1
            <i class="m-icon-swapright">+</i>
        </a> -->
                <a class="more" href="#"> &nbsp;
                    <i class="am-icon-angle-left icon-add-left" @click='insertleft'></i>
                    <!-- <i class="am-icon-angle-right  tpl-left-nav-more-ico-rotate icon-add-center" @click='insertbottom'></i> -->
                   
                    <i class="am-icon-angle-right  icon-add-right" @click='insertright'></i>
                </a>
            </div>
        </div>
    </script>
    <script type="text/x-template" id="task_component">
        <div  style="width: 200px; margin-right:5px">
            <slot name="task_component_content">
                <div class="dashboard-stat green" @dblclick='doubleclick'>
                    <!-- <div class="visual">
                        <i class="am-icon-apple"></i>
                    </div> -->
                    <div class="details">
                        <div class="number"> {{story_card.title}} </div>
                        <div class="desc"> {{story_card.description}} </div>
                    </div>
                    <a class="more" href="#"> {{story_card.status}}
                        <i class="m-icon-swapright" style="float:right">{{story_card.points}}</i>
                    </a>
                </div>
            </slot>
        </div>
    </script>

    <script type="text/x-template" id="task_add_component">
        <div  style="width: 200px; margin-right:5px">
            <span @click='clickIcon' class="am-icon-plus task-extend-span">
                </span>
        </div>
    </script>

    <script type="text/x-template" id="release_component">
        <div class="tpl-block">
            <div class="am-g">
                <div class="am-u-sm-12 am-u-md-2">
                    <div class="am-btn-toolbar">
                        <div class="am-btn-group am-btn-group-xs">
                            <span class="am-icon-plus" @click='showrelease'></span>
                            {{release_card.title}}
                        </div>
                    </div>
                </div>
                <div class="am-u-sm-12 am-u-md-3" @dblclick='doubleclick'>
                    <span class="am-icon-calendar">&nbsp;开始</span>   {{dateFormat(release_card.start)}}

                </div>
                <div class="am-u-sm-12 am-u-md-3" @dblclick='doubleclick' >
                    <span class="am-icon-calendar">&nbsp;结束</span>   {{dateFormat(release_card.end)}}

                </div>
                <div class="am-u-sm-12 am-u-md-1" @dblclick='doubleclick' >
                    {{release_card.status}}
                </div>
                <div class="am-u-sm-12 am-u-md-2" style="color: #F44336;" @click='addclick'>
                    <span class="am-icon-bullhorn">&nbsp;添加新迭代</span>

                </div>


            </div>
        </div>


    </script>





    <!-- template for the modal component -->
    <script type="text/x-template" id="modal-backbone-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">

                        <div class="modal-header">
                            <slot name="header">
                                添加骨干故事
                            </slot>
                            <i class="modal-default-close am-icon-remove" @click="$emit('close')"></i>
                        </div>

                        <div class="modal-body">
                            <slot name="body">
                                <div class="tpl-form-body tpl-form-line">
                                    <form class="am-form tpl-form-line-form">
                                        <div class="am-form-group">
                                            <label for="user-name" class="am-u-sm-3 am-form-label">名称 <span class="tpl-form-line-small-title">Title</span></label>
                                            <div class="am-u-sm-9">
                                                <input type="text" class="tpl-form-input" id="user-name" placeholder="请输入标题文字" v-model="backbone_data_in_modal.title">

                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-email" class="am-u-sm-3 am-form-label">描述 <span class="tpl-form-line-small-title">Description</span></label>
                                            <div class="am-u-sm-9">
                                                <textarea class="" rows="3" id="user-intro" placeholder="请输入描述" v-model="backbone_data_in_modal.description">{{backbone_data_in_modal.description}}</textarea>
                                            </div>
                                        </div>
                                        <div class="am-form-group">
                                            <div class="am-u-sm-9 am-u-sm-push-3">
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " @click='clicksubmit'>提交</button>
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-danger " @click='clickdelete'>删除此卡片</button>

                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </slot>
                        </div>

                    </div>
                </div>
            </div>
        </transition>
    </script>

    <script type="text/x-template" id="modal-activity-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">

                        <div class="modal-header">
                            <slot name="header">
                                添加活动
                            </slot>
                            <i class="modal-default-close am-icon-remove" @click="$emit('close')"></i>
                        </div>

                        <div class="modal-body">
                            <slot name="body">
                                <div class="tpl-form-body tpl-form-line">
                                    <form class="am-form tpl-form-line-form">
                                        <div class="am-form-group">
                                            <label for="user-name" class="am-u-sm-3 am-form-label">名称 <span class="tpl-form-line-small-title">Title</span></label>
                                            <div class="am-u-sm-9">
                                                <input type="text" class="tpl-form-input" id="user-name" placeholder="请输入标题文字" v-model="activity_data_in_modal.title">

                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-email" class="am-u-sm-3 am-form-label">描述 <span class="tpl-form-line-small-title">Description</span></label>
                                            <div class="am-u-sm-9">
                                                <!-- <input type="text" class="am-form-field tpl-form-no-bg" placeholder="请输入描述" data-am-datepicker="" readonly/> -->
                                                <textarea class="" rows="3" id="user-intro" placeholder="请输入描述" v-model="activity_data_in_modal.description">{{activity_data_in_modal.description}}</textarea>
                                            </div>
                                        </div>
                                        <div class="am-form-group">
                                            <div class="am-u-sm-9 am-u-sm-push-3">
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " @click='clicksubmit'>提交</button>
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-danger " @click='clickdelete'>删除此卡片</button>

                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </slot>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </script>

    <script type="text/x-template" id="modal-task-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">

                        <div class="modal-header">
                            <slot name="header">
                                添加任务
                            </slot>
                            <i class="modal-default-close am-icon-remove" @click="$emit('close')"></i>
                        </div>

                        <div class="modal-body">
                            <slot name="body">
                                <div class="tpl-form-body tpl-form-line">
                                    <form class="am-form tpl-form-line-form">
                                        <div class="am-form-group">
                                            <label for="user-name" class="am-u-sm-3 am-form-label">名称 <span class="tpl-form-line-small-title">Title</span></label>
                                            <div class="am-u-sm-9">
                                                <input type="text" class="tpl-form-input" id="user-name" placeholder="请输入标题文字" v-model="task_data_in_modal.title">

                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-email" class="am-u-sm-3 am-form-label">描述 <span class="tpl-form-line-small-title">Description</span></label>
                                            <div class="am-u-sm-9">
                                                <!-- <input type="text" class="am-form-field tpl-form-no-bg" placeholder="请输入描述" data-am-datepicker="" readonly/> -->
                                                <textarea class="" rows="2" id="user-intro" placeholder="请输入描述" v-model="task_data_in_modal.description"></textarea>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-email" class="am-u-sm-3 am-form-label">时间 <span class="tpl-form-line-small-title">Time</span></label>
                                            <div class="am-u-sm-9">
                                                <!-- <input type="text" class="am-form-field tpl-form-no-bg" placeholder="发布时间" data-am-datepicker="" readonly/>
                                                <small>发布时间为必填</small> -->
                                                <div class="block">
                                                    <el-date-picker

                                                            v-model="date_value"
                                                            type="datetimerange"
                                                            align="right"
                                                            start-placeholder="开始日期"
                                                            end-placeholder="结束日期"
                                                            :default-time="['8:00:00', '18:00:00']">
                                                    </el-date-picker>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label class="am-u-sm-3 am-form-label">故事点 <span class="tpl-form-line-small-title">Storypoint</span></label>
                                            <div class="am-u-sm-9">
                                                <input type="number" placeholder="输入预估故事点" v-model="task_data_in_modal.points">
                                            </div>
                                        </div>
                                        <div class="am-form-group">
                                            <label for="user-phone" class="am-u-sm-3 am-form-label">状态 <span class="tpl-form-line-small-title">Status</span></label>
                                            <div class="am-u-sm-9">

                                                <el-select v-model="task_data_in_modal.status" placeholder="请选择" size="medium" clearable>
                                                    <el-option
                                                            v-for="item in cities"
                                                            :key="item.value"
                                                            :label="item.label"
                                                            :value="item.value">
                                                        <span style="float: left">{{ item.label }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ item.value }}</span>
                                                    </el-option>
                                                </el-select>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <div class="am-u-sm-9 am-u-sm-push-3">
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " @click='clicksubmit'>提交</button>
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-danger " @click='clickdelete'>删除此卡片</button>

                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </slot>
                        </div>

                        <!-- <div class="modal-footer">
                          <slot name="footer">
                            default footer
                            <button class="modal-default-button" @click="$emit('close')">
                              OK
                            </button>
                          </slot>
                        </div> -->
                    </div>
                </div>
            </div>
        </transition>
    </script>

    <script type="text/x-template" id="modal-develop-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">

                        <div class="modal-header">
                            <slot name="header">
                                添加发行周期
                            </slot>
                            <i class="modal-default-close am-icon-remove" @click="$emit('close')"></i>
                        </div>

                        <div class="modal-body">
                            <slot name="body">
                                <div class="tpl-form-body tpl-form-line">
                                    <form class="am-form tpl-form-line-form">
                                        <div class="am-form-group">
                                            <label for="user-name" class="am-u-sm-3 am-form-label">名称 <span class="tpl-form-line-small-title">Title</span></label>
                                            <div class="am-u-sm-9">
                                                <input type="text" class="tpl-form-input" id="user-name" placeholder="请输入标题文字" v-model="release_data_in_modal.title">

                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-email" class="am-u-sm-3 am-form-label">描述 <span class="tpl-form-line-small-title">Description</span></label>
                                            <div class="am-u-sm-9">
                                                <!-- <input type="text" class="am-form-field tpl-form-no-bg" placeholder="请输入描述" data-am-datepicker="" readonly/> -->
                                                <textarea class="" rows="2" id="user-intro" placeholder="请输入描述" v-model="release_data_in_modal.description"></textarea>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-email" class="am-u-sm-3 am-form-label">发布时间 <span class="tpl-form-line-small-title">Time</span></label>
                                            <div class="am-u-sm-9">
                                                <!-- <input type="text" class="am-form-field tpl-form-no-bg" placeholder="发布时间" data-am-datepicker="" readonly/>
                                                <small>发布时间为必填</small> -->
                                                <div class="block">
                                                    <el-date-picker

                                                            v-model="date_value"
                                                            type="datetimerange"
                                                            align="right"
                                                            start-placeholder="开始日期"
                                                            end-placeholder="结束日期"
                                                            :default-time="['8:00:00', '18:00:00']">
                                                    </el-date-picker>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="am-form-group">
                                            <label for="user-phone" class="am-u-sm-3 am-form-label">状态 <span class="tpl-form-line-small-title">Status</span></label>
                                            <div class="am-u-sm-9">

                                                <el-select v-model="release_data_in_modal.status" placeholder="请选择" size="medium" clearable>
                                                    <el-option
                                                            v-for="item in cities"
                                                            :key="item.value"
                                                            :label="item.label"
                                                            :value="item.value">
                                                        <span style="float: left">{{ item.label }}</span>
                                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ item.value }}</span>
                                                    </el-option>
                                                </el-select>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <div class="am-u-sm-9 am-u-sm-push-3">
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-success " @click='clicksubmit'>提交</button>
                                                <button type="button" class="am-btn am-btn-primary tpl-btn-bg-color-danger " @click='clickdelete'>删除此周期</button>

                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </slot>
                        </div>

                        <!-- <div class="modal-footer">
                          <slot name="footer">
                            default footer
                            <button class="modal-default-button" @click="$emit('close')">
                              OK
                            </button>
                          </slot>
                        </div> -->
                    </div>
                </div>
            </div>
        </transition>
    </script>


    <script>


    //注册组件
    Vue.component('back-bone-component', {
        template: '#back_bone_component',
        props: ['backbone_card', 'index'],
        data() {
            return {
            }
        },
        methods: {

            doubleclick: function () {
                this.$emit('doubleclick', this.backbone_card, this.index);
            },
            insertleft: function () {
                this.$emit('insertleft', this.backbone_card.sequenceId);
            },
            insertbottom: function () {
                this.$emit('insertbottom',-1,this.index);
            },
            insertright: function () {
                this.$emit('insertright', this.backbone_card.sequenceId + 1);
            }
        }
    });

    Vue.component('activity-component', {
        template: '#activity_component',
        props: ['activity_card', 'backbone_index', 'activity_index'],
        data() {
            return {

            }
        },
        methods: {
            doubleclick: function () {
                this.$emit('doubleclick', this.activity_card, this.backbone_index, this.activity_card);
            },
            insertleft: function () {
                this.$emit('insertleft', this.activity_card.sequenceId,this.backbone_index);
            },
            insertbottom: function () {
                this.$emit('insertbottom', this.backbone_index, this.activity_index);
            },
            insertright: function () {
                this.$emit('insertright', this.activity_card.sequenceId + 1,this.backbone_index);
            }

        }
    });

    Vue.component('task-component', {
        template: '#task_component',
        props: ['story_card','backbone_index','activity_index','release_index','seq_id'],
        data() {
            return {

            }
        },
        methods: {
            doubleclick: function () {
                this.$emit('doubleclick', this.story_card);
            },

        }
    });
    Vue.component('task-add-component', {
        template: '#task_add_component',
        props: ['story_card','backbone_index','activity_index','release_index','seq_id'],
        data() {
            return {

            }
        },
        methods: {
            clickIcon:function(){
                console.log(this.backbone_index,this.activity_index,this.release_index,this.seq_id)
                 this.$emit('clickicon',this.backbone_index,this.activity_index,this.release_index,this.seq_id)
            }

        }
    });


    Vue.component('release-component', {
        template: '#release_component',
        props: ['release_card', 'index'],
        data() {
            return {
            }
        },
        methods: {
            doubleclick: function () {
                this.$emit('doubleclick', this.release_card);
            },
            addclick:function(){
                this.$emit('addclick', this.release_card,this.release_card.sequenceId);
            },
            showrelease:function(){
                this.$emit('showrelease', this.index);
            },
             //时间格式化函数，此处仅针对yyyy-MM-dd hh:mm:ss 的格式进行格式化
             dateFormat:function(time) {
                var date=new Date(time);
                var year=date.getFullYear();
                /* 在日期格式中，月份是从0开始的，因此要加0
                * 使用三元表达式在小于10的前面加0，以达到格式统一  如 09:11:05
                * */
                var month= date.getMonth()+1<10 ? "0"+(date.getMonth()+1) : date.getMonth()+1;
                var day=date.getDate()<10 ? "0"+date.getDate() : date.getDate();
                var hours=date.getHours()<10 ? "0"+date.getHours() : date.getHours();
                var minutes=date.getMinutes()<10 ? "0"+date.getMinutes() : date.getMinutes();
                var seconds=date.getSeconds()<10 ? "0"+date.getSeconds() : date.getSeconds();
                // 拼接
                return year+"-"+month+"-"+day+" "+hours+":"+minutes+":"+seconds;
            },
        }
    });

    Vue.component('backbone-modal', {
        template: '#modal-backbone-template',
        props: ['backbone_data_in_modal', 'backbone_index'],
        data() {
            return {

            }
        },
        methods: {
            clicksubmit: function () {
                this.$emit('clicksubmit', this.backbone_data_in_modal, this.backbone_index);
            },
            clickdelete: function () {
                this.$emit('clickdelete', this.backbone_data_in_modal, this.backbone_index);
            }
        },

    });

    Vue.component('activity-modal', {
        template: '#modal-activity-template',
        props: ['activity_data_in_modal', 'backbone_index', 'activity_index'],
        data() {
            return {

            }
        },
        methods: {
            clicksubmit: function () {
                this.$emit('clicksubmit', this.activity_data_in_modal, this.backbone_index, this.activity_index);
            },
            clickdelete: function () {
                this.$emit('clickdelete', this.activity_data_in_modal, this.backbone_index, this.activity_index);
            }
        },
    });

    Vue.component('task-modal', {
        template: '#modal-task-template',
        props: ['task_data_in_modal'],
        data() {
            return {
                cities: [{
                    value: '0',
                    label: 'UNDO'
                }, {
                    value: '1',
                    label: 'DOING'
                }, {
                    value: '2',
                    label: 'DONE'
                }],
                value6: '',
                date_value:[],
            };
        },
        methods:{
            clicksubmit: function () {
                this.task_data_in_modal.start = this.date_value[0]
                this.task_data_in_modal.end = this.date_value[1]
                this.$emit('clicksubmit', this.task_data_in_modal);
            },
            clickdelete: function () {
                this.$emit('clickdelete', this.task_data_in_modal);
            },
        },
        created() {
            //日期格式转换
            this.date_value[0]=this.task_data_in_modal.start
            this.date_value[1]=this.task_data_in_modal.end
        },

    });

    Vue.component('develop-modal', {
        template: '#modal-develop-template',
        props: ['release_data_in_modal'],
        data() {
            return {
                cities: [{
                    value: '0',
                    label: 'UNDO'
                }, {
                    value: '1',
                    label: 'DOING'
                }, {
                    value: '2',
                    label: 'DONE'
                }],
                date_value:[],
            }
        },
        methods: {
            clicksubmit: function () {
                this.release_data_in_modal.start = this.date_value[0]
                this.release_data_in_modal.end = this.date_value[1]
                console.log("this",this.release_data_in_modal.status)
                this.$emit('clicksubmit', this.release_data_in_modal);
            },
            clickdelete: function () {
                this.$emit('clickdelete', this.release_data_in_modal);
            },
        },
        created() {
            //日期格式转换
            this.date_value[0]=this.release_data_in_modal.start
            this.date_value[1]=this.release_data_in_modal.end
        },
    });


    //创建根结点
    new Vue({
        el: '#app',
        data: {
            basepath: "",
            userId: 0,
            userName: "sweets",
            story_count: 0,
            backboneList: [],
            releaseList: [],
            memberList: [],
            current_backbone: {
            },
            current_backbone_index: 0,
            current_activity: {},
            current_activity_index: 0,
            current_story: {},
            current_story_index: 0,
            current_release:{},
            showBackBoneModal: 0,    // 0 -关闭 1-新增 2-修改
            showActivityModal: 0,
            showTaskModal: 0,
            showDevelopModal: 0,
            showReleaseContent:[
                {
          show: true
        },
        {
            show: true
        },
        {
            show: true
        },
        {
            show: true
        },
        {
            show: true
        }
        ],
        },
        methods: {
            indexs: function () {
                ///获取project ID 和 userId 和 userName
                if (sessionStorage.getItem('username')===null){
                    window.location.href="login.html";
                }else{
                    this.userName=sessionStorage.getItem('username');
                    this.userId=sessionStorage.getItem('uid');
                    this.basepath="http://172.19.240.113/ui/project/"+sessionStorage.getItem('pid')+"/";
            }
            },
            addbackbone: function (seq) {
                this.current_backbone = {}
                this.current_backbone.sequenceId = seq-1
                this.current_backbone.creatorId = this.userId
                this.showBackBoneModal = 1
            },
            addactivity: function (seq,backbone_index) {

                this.current_activity = {}
                this.current_activity.creatorId = this.userId
                this.current_activity.epicId = this.backboneList[backbone_index].id
                if (seq == -1){//此时是向下新增
                    if(this.backboneList[backbone_index].activityList.length==0){
                        this.current_activity.sequenceId = 0
                    }else{
                        last_index = this.backboneList[backbone_index].activityList.length-1
                        this.current_activity.sequenceId = this.backboneList[backbone_index].activityList[last_index].sequenceId+1
                    }
                }else{
                    this.current_activity.sequenceId = seq-1
                }
                this.showActivityModal = 1
            },
            addstory: function (backbone_index,activity_index,release_index,seq_id) {
                console.log(backbone_index,activity_index,release_index,seq_id)
                if(this.backboneList[backbone_index].activityList[activity_index]==null){
                    alert("Please add activity first")
                }else{

                
                this.current_story = {}
                this.current_story.creatorId = this.userId
                this.current_story.epicId = this.backboneList[backbone_index].id
                
                this.current_story.activityId= this.backboneList[backbone_index].activityList[activity_index].id
                this.current_story.releaseId =this.releaseList[release_index].id
                this.current_story.sequenceId = seq_id
                this.showTaskModal = 1
                }
            },
            addrelease:function(release,seq){
                this.current_release = {}
                this.current_release.sequenceId = seq-1
                this.showDevelopModal = 1
            },
         

            updatebackbone: function (backbone_card, index) {
                console.log("骨干故事的backbone_card，index是 " + backbone_card, index)
                this.current_backbone = backbone_card
                this.current_backbone_index = index
                this.showBackBoneModal = 2
            },
            updateactivity: function (activity_card, backbone_index, activity_index) {
                console.log("活动的backbone_card，backbone_index,activity_index是 " + activity_card, backbone_index, activity_index)
                this.current_activity = activity_card
                this.current_backbone_index = backbone_index
                this.current_activity_index = activity_index
                this.showActivityModal = 2
            },
            updatetask: function (task_card) {
                this.current_story = task_card
                this.showTaskModal = 2
            },
            updaterelease:function(release_card){
                this.current_release = release_card
                this.showDevelopModal = 2
            },
            showrelease:function(index){
                console.log(this.showReleaseContent[index])
                this.showReleaseContent[index].show = !this.showReleaseContent[index].show
                console.log(this.showReleaseContent[index])
            },
            getAllData: function () {
                _this = this
                axios({
                    method: 'get',
                    url: this.basepath,
                    data: {
                    },
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }

                })
                    .then(function (res) {
                        if (res.data.status == "SUCCESS") {
                            _this.backboneList = res.data.epicList;
                            _this.memberList = res.data.memberList;
                            _this.releaseList = res.data.releaseList;

                            //如果是新的没有东西的项目，先创建一个骨干卡片
                            if(_this.backboneList.length==0){
                                _this.initProject()
                                
                            }

                        }
                        else {
                            alert("请求数据失败，请刷新页面重试")
                        }
                    });
            },
            initProject:function(){
                this.current_backbone = {
                    creatorId: this.userId,
                    description: "编辑你的第一张卡片",
                    sequenceId: 1,
                    title: "现在开始吧！"
                }
                this.current_release = {
                    creatorId: this.userId,
                    sequenceId: 1,
                    title: "MVP迭代",
                    description: "编辑你的第一个迭代吧！",
                    end: "2019-04-25T16:00:00.000+0000",
                    start: "2019-04-10T16:00:00.000+0000",
                    status: "UNDO",
                }
                this.addOrUpdateBackbone(this.current_backbone,0)
                this.addOrUpdateRelease(this.current_release)
            },
            addOrUpdateBackbone: function (current_backbone, index) {
                _this = this;
                console.log(current_backbone)
                axios({
                    method: 'post',
                    url: this.basepath + "insert/epic",
                    data: current_backbone,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        if (res.data.status == "SUCCESS") {
                            
                            _this.showBackBoneModal = 0
                            _this.current_backbone = {}
                            _this.getAllData()
                        } else {
                            alert("网络请求失败，请重新编辑")
                        }
                    });
            },
            addOrUpdateActivity: function (current_activity,backbone_index,activity_index) {
                _this = this;
                console.log(current_activity)
                axios({
                    method: 'post',
                    url: this.basepath + "insert/activity",
                    data: current_activity,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        if (res.data.status == "SUCCESS") {
                            _this.showActivityModal = 0
                            _this.current_activity = {}
                            _this.getAllData()
                        } else {
                            alert("网络请求失败，请重新编辑")
                        }

                    });
            },
            addOrUpdateTask: function (current_task) {
                console.log(current_task)
                current_task.start=this.dateFormatToPost(current_task.start)
                current_task.end=this.dateFormatToPost(current_task.end)

                if(current_task.status=="UNDO"){
                    current_task.status=0
                }
                else if(current_task.status=="DOING"){
                    current_task.status=1
                }
                else{
                    current_task.status=2
                }
                console.log(current_task)
                axios({
                    method: 'post',
                    url: this.basepath + "story",
                    data:current_task,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        if (res.data.status == "SUCCESS") {
                            _this.backboneList= res.data.epicList
                            _this.releaseList = res.data.releaseList
                            _this.showTaskModal = 0
                            _this.current_task = {}
                        } else {
                            alert("网络请求失败，请重新编辑")
                        }


                    });
            },
            addOrUpdateRelease: function (current_release) {
                console.log(current_release)
                current_release.start=this.dateFormatToPost(current_release.start)
                current_release.end=this.dateFormatToPost(current_release.end)

                if(current_release.status=="UNDO"){
                    current_release.status=0
                }
                else if(current_release.status=="DOING"){
                    current_release.status=1
                }
                else{
                    current_release.status=2
                }

                console.log(current_release)

                axios({
                    method: 'post',
                    url: this.basepath + "release",
                    data: current_release,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        if (res.data.status == "SUCCESS") {
                            _this.showDevelopModal = 0
                            _this.current_release = {}
                            _this.getAllData()
                        } else {
                            alert("网络请求失败，请重新编辑")
                        }
                    });
            },

            deleteBackbone: function (current_backbone, index) {
            
                _this = this;
                console.log(current_backbone)
                axios({
                    method: 'delete',
                    url: this.basepath + "epic/"+current_backbone.id,
                    // data: current_backbone,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        if (res.data == true) {
                             
                            _this.showBackBoneModal = 0
                            _this.current_backbone = {}
                            _this.getAllData()
                        } else {
                            alert("网络请求失败，请重新删除")
                        }
                    });
            },
            deleteActivity: function (current_activity,backbone_index,activity_index) {
                console.log("deleteActivity")
                _this = this;
                console.log(current_activity)
                axios({
                    method: 'delete',
                    url: this.basepath + "activity/"+current_activity.id,
                    // data: current_activity,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                       
                        if (res.data == true) {
                            _this.showActivityModal = 0
                            _this.current_activity = {}
                             _this.getAllData()
                         } else {
                             alert("网络请求失败，请重新删除")
                         }

                    });
            },
            deleteTask:function(current_task){
                console.log("deleteTask")
                console.log(current_task)
                axios({
                    method: 'delete',
                    url: this.basepath + "story",
                    data:current_task,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        if (res.data == true) {
                            _this.showTaskModal = 0
                            _this.current_task = {}
                             _this.getAllData()
                         } else {
                             alert("网络请求失败，请重新删除")
                         }

                    });
            },
            deleteRelease:function(current_release){
                console.log("deleteRelease")
                console.log(current_release)
              
                axios({
                    method: 'delete',
                    url: this.basepath + "release/"+current_release.id,
                    data: current_release,
                    headers: {
                        'Content-Type': 'application/json',
                    }

                })
                    .then(function (res) {
                        console.log(res.data);
                        
                        if (res.data == true) {
                            _this.showDevelopModal = 0
                            _this.current_release = {}
                             _this.getAllData()
                         } else {
                             alert("网络请求失败，请重新删除")
                         }

                    });
            },
            //时间格式化函数，此处仅针对yyyy-MM-dd hh:mm:ss 的格式进行格式化
            dateFormat:function(time) {
                var date=new Date(time);
                var year=date.getFullYear();
                /* 在日期格式中，月份是从0开始的，因此要加0
                * 使用三元表达式在小于10的前面加0，以达到格式统一  如 09:11:05
                * */
                var month= date.getMonth()+1<10 ? "0"+(date.getMonth()+1) : date.getMonth()+1;
                var day=date.getDate()<10 ? "0"+date.getDate() : date.getDate();
                var hours=date.getHours()<10 ? "0"+date.getHours() : date.getHours();
                var minutes=date.getMinutes()<10 ? "0"+date.getMinutes() : date.getMinutes();
                var seconds=date.getSeconds()<10 ? "0"+date.getSeconds() : date.getSeconds();
                // 拼接
                return year+"-"+month+"-"+day+" "+hours+":"+minutes+":"+seconds;
            },
             //时间格式化函数，此处仅针对yyyy-MM-dd hh:mm:ss 的格式进行格式化
             dateFormatToPost:function(time) {
                var date=new Date(time);
                var year=date.getFullYear();
                /* 在日期格式中，月份是从0开始的，因此要加0
                * 使用三元表达式在小于10的前面加0，以达到格式统一  如 09:11:05
                * */
                var month= date.getMonth()+1<10 ? "0"+(date.getMonth()+1) : date.getMonth()+1;
                var day=date.getDate()<10 ? "0"+date.getDate() : date.getDate();
                var hours=date.getHours()<10 ? "0"+date.getHours() : date.getHours();
                var minutes=date.getMinutes()<10 ? "0"+date.getMinutes() : date.getMinutes();
                var seconds=date.getSeconds()<10 ? "0"+date.getSeconds() : date.getSeconds();
                // 拼接
                return year+month+day;
            },
            //下载图片
             downloadPng:function(){
                let a = document.createElement('a');
                a.style.display = "none";
                setTimeout(function(){
                    html2canvas(document.body)
                    .then(canvas => {
                    console.log(canvas);
                    a.setAttribute("href",canvas.toDataURL('image/png') );
                    a.setAttribute("download", "screen_cut.png")
                    a.click();
                });

                },1000);

            },
            //图片转格式
            dataURLToBlob:function(dataUrl){
                var arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], {type: mime})
            },


        },
        created() {
            //自动加载indexs方法
            this.indexs();
            this.getAllData();
        },
    })
</script>

</body>




</html>







